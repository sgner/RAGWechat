# æŠ€æœ¯æ¶æ„è¯¦ç»†è¯´æ˜

## ğŸ—ï¸ æ•´ä½“æ¶æ„è®¾è®¡

### åˆ†å±‚æ¶æ„æ¨¡å¼

æœ¬é¡¹ç›®é‡‡ç”¨ç»å…¸çš„åˆ†å±‚æ¶æ„æ¨¡å¼ï¼Œä»ä¸Šåˆ°ä¸‹åˆ†ä¸ºï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è¡¨ç°å±‚ (Presentation Layer)          â”‚
â”‚  â”œâ”€â”€ WXML æ¨¡æ¿                                          â”‚
â”‚  â”œâ”€â”€ WXSS æ ·å¼                                          â”‚
â”‚  â””â”€â”€ ç”¨æˆ·äº¤äº’é€»è¾‘                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    ä¸šåŠ¡é€»è¾‘å±‚ (Business Logic Layer)     â”‚
â”‚  â”œâ”€â”€ é¡µé¢æ§åˆ¶å™¨ (Page Controllers)                      â”‚
â”‚  â”œâ”€â”€ ä¸šåŠ¡æœåŠ¡ (Business Services)                       â”‚
â”‚  â””â”€â”€ çŠ¶æ€ç®¡ç† (State Management)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    æ•°æ®è®¿é—®å±‚ (Data Access Layer)       â”‚
â”‚  â”œâ”€â”€ API æ¥å£å°è£…                                       â”‚
â”‚  â”œâ”€â”€ æ•°æ®è½¬æ¢å™¨                                         â”‚
â”‚  â””â”€â”€ ç¼“å­˜ç®¡ç†                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    åŸºç¡€è®¾æ–½å±‚ (Infrastructure Layer)     â”‚
â”‚  â”œâ”€â”€ ç½‘ç»œè¯·æ±‚                                           â”‚
â”‚  â”œâ”€â”€ æœ¬åœ°å­˜å‚¨                                           â”‚
â”‚  â”œâ”€â”€ å·¥å…·å‡½æ•°                                           â”‚
â”‚  â””â”€â”€ ç¬¬ä¸‰æ–¹æœåŠ¡                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨¡å—åŒ–è®¾è®¡

#### 1. é¡µé¢æ¨¡å— (Pages)
```
pages/
â”œâ”€â”€ home/                    # çŸ¥è¯†åº“åˆ—è¡¨é¡µ
â”‚   â”œâ”€â”€ home.js             # é¡µé¢é€»è¾‘
â”‚   â”œâ”€â”€ home.wxml           # é¡µé¢æ¨¡æ¿
â”‚   â”œâ”€â”€ home.wxss           # é¡µé¢æ ·å¼
â”‚   â””â”€â”€ home.json           # é¡µé¢é…ç½®
â”œâ”€â”€ knowledge-detail/        # çŸ¥è¯†åº“è¯¦æƒ…é¡µ
â”œâ”€â”€ chat/                   # å¯¹è¯é¡µé¢
â””â”€â”€ profile/                # ä¸ªäººä¸­å¿ƒé¡µ
```

#### 2. å·¥å…·æ¨¡å— (Utils)
```
utils/
â”œâ”€â”€ api.js                  # APIæ¥å£å°è£…
â”œâ”€â”€ request.js              # ç½‘ç»œè¯·æ±‚å°è£…
â”œâ”€â”€ storage.js              # æœ¬åœ°å­˜å‚¨ç®¡ç†
â”œâ”€â”€ markdown-parser.js      # Markdownè§£æå™¨
â”œâ”€â”€ constants.js            # å¸¸é‡å®šä¹‰
â””â”€â”€ helpers.js              # å·¥å…·å‡½æ•°
```

#### 3. ç»„ä»¶æ¨¡å— (Components)
```
components/
â”œâ”€â”€ common/                 # é€šç”¨ç»„ä»¶
â”œâ”€â”€ business/               # ä¸šåŠ¡ç»„ä»¶
â””â”€â”€ ui/                     # UIç»„ä»¶
```

## ğŸ”§ æ ¸å¿ƒæŠ€æœ¯å®ç°

### 1. Markdown è§£æå¼•æ“

#### æ¶æ„è®¾è®¡
```javascript
class MarkdownParser {
  constructor() {
    // åˆå§‹åŒ–è§£æè§„åˆ™
    this.initializeRules();
    // åˆå§‹åŒ–èŠ‚ç‚¹å·¥å‚
    this.nodeFactory = new NodeFactory();
  }
  
  // ä¸»è§£ææµç¨‹
  parse(markdown) {
    // 1. é¢„å¤„ç†é˜¶æ®µ
    const preprocessed = this.preprocess(markdown);
    
    // 2. è¯æ³•åˆ†æé˜¶æ®µ
    const tokens = this.tokenize(preprocessed);
    
    // 3. è¯­æ³•åˆ†æé˜¶æ®µ
    const ast = this.parseTokens(tokens);
    
    // 4. ä»£ç ç”Ÿæˆé˜¶æ®µ
    const nodes = this.generateNodes(ast);
    
    return nodes;
  }
}
```

#### è§£æè§„åˆ™å¼•æ“
```javascript
// è§„åˆ™å®šä¹‰
const MARKDOWN_RULES = {
  // å—çº§å…ƒç´ 
  BLOCK_ELEMENTS: {
    heading: {
      pattern: /^(#{1,6})\s+(.+)$/gm,
      priority: 10,
      handler: 'createHeadingNode'
    },
    codeBlock: {
      pattern: /```(\w*)\n([\s\S]*?)```/g,
      priority: 20,
      handler: 'createCodeBlockNode'
    },
    blockquote: {
      pattern: /^>\s+(.+)$/gm,
      priority: 15,
      handler: 'createBlockquoteNode'
    }
  },
  
  // è¡Œå†…å…ƒç´ 
  INLINE_ELEMENTS: {
    bold: {
      pattern: /\*\*(.*?)\*\*|__(.*?)__/g,
      priority: 5,
      handler: 'createBoldNode'
    },
    italic: {
      pattern: /\*(.*?)\*|_(.*?)_/g,
      priority: 4,
      handler: 'createItalicNode'
    },
    inlineCode: {
      pattern: /`([^`]+)`/g,
      priority: 8,
      handler: 'createInlineCodeNode'
    }
  }
};
```

#### èŠ‚ç‚¹å·¥å‚æ¨¡å¼
```javascript
class NodeFactory {
  createNode(type, content, attributes = {}) {
    const nodeCreators = {
      'heading': this.createHeadingNode,
      'paragraph': this.createParagraphNode,
      'codeBlock': this.createCodeBlockNode,
      'list': this.createListNode,
      'blockquote': this.createBlockquoteNode
    };
    
    const creator = nodeCreators[type];
    if (!creator) {
      throw new Error(`Unknown node type: ${type}`);
    }
    
    return creator.call(this, content, attributes);
  }
  
  createHeadingNode(content, { level = 1 } = {}) {
    return {
      name: 'div',
      attrs: {
        style: this.getHeadingStyle(level)
      },
      children: this.parseInlineContent(content)
    };
  }
}
```

### 2. ç½‘ç»œè¯·æ±‚æ¶æ„

#### è¯·æ±‚æ‹¦æˆªå™¨è®¾è®¡
```javascript
class RequestInterceptor {
  constructor() {
    this.requestInterceptors = [];
    this.responseInterceptors = [];
  }
  
  // æ·»åŠ è¯·æ±‚æ‹¦æˆªå™¨
  addRequestInterceptor(interceptor) {
    this.requestInterceptors.push(interceptor);
  }
  
  // æ·»åŠ å“åº”æ‹¦æˆªå™¨
  addResponseInterceptor(interceptor) {
    this.responseInterceptors.push(interceptor);
  }
  
  // æ‰§è¡Œè¯·æ±‚æ‹¦æˆª
  async interceptRequest(config) {
    for (const interceptor of this.requestInterceptors) {
      config = await interceptor(config);
    }
    return config;
  }
  
  // æ‰§è¡Œå“åº”æ‹¦æˆª
  async interceptResponse(response) {
    for (const interceptor of this.responseInterceptors) {
      response = await interceptor(response);
    }
    return response;
  }
}
```

#### API æ¥å£æŠ½è±¡å±‚
```javascript
class ApiClient {
  constructor(baseURL, interceptor) {
    this.baseURL = baseURL;
    this.interceptor = interceptor;
    this.setupInterceptors();
  }
  
  setupInterceptors() {
    // è¯·æ±‚æ‹¦æˆªï¼šæ·»åŠ è®¤è¯ä¿¡æ¯
    this.interceptor.addRequestInterceptor(async (config) => {
      const loginInfo = await this.getLoginInfo();
      if (loginInfo) {
        config.header = {
          ...config.header,
          'Authorization': `Bearer ${loginInfo.token}`
        };
      }
      return config;
    });
    
    // å“åº”æ‹¦æˆªï¼šç»Ÿä¸€é”™è¯¯å¤„ç†
    this.interceptor.addResponseInterceptor(async (response) => {
      if (response.statusCode === 401) {
        await this.handleUnauthorized();
      }
      return response;
    });
  }
  
  async request(url, method = 'GET', data = null, options = {}) {
    let config = {
      url: `${this.baseURL}${url}`,
      method,
      data,
      ...options
    };
    
    // æ‰§è¡Œè¯·æ±‚æ‹¦æˆª
    config = await this.interceptor.interceptRequest(config);
    
    // å‘é€è¯·æ±‚
    const response = await this.sendRequest(config);
    
    // æ‰§è¡Œå“åº”æ‹¦æˆª
    return await this.interceptor.interceptResponse(response);
  }
}
```

### 3. çŠ¶æ€ç®¡ç†ç³»ç»Ÿ

#### å…¨å±€çŠ¶æ€ç®¡ç†
```javascript
class GlobalStateManager {
  constructor() {
    this.state = {
      user: null,
      currentKnowledgeBase: null,
      currentSession: null,
      loginInfo: null
    };
    this.listeners = new Map();
  }
  
  // è®¢é˜…çŠ¶æ€å˜åŒ–
  subscribe(key, callback) {
    if (!this.listeners.has(key)) {
      this.listeners.set(key, []);
    }
    this.listeners.get(key).push(callback);
    
    // è¿”å›å–æ¶ˆè®¢é˜…å‡½æ•°
    return () => {
      const callbacks = this.listeners.get(key);
      const index = callbacks.indexOf(callback);
      if (index > -1) {
        callbacks.splice(index, 1);
      }
    };
  }
  
  // æ›´æ–°çŠ¶æ€
  setState(key, value) {
    const oldValue = this.state[key];
    this.state[key] = value;
    
    // é€šçŸ¥è®¢é˜…è€…
    const callbacks = this.listeners.get(key) || [];
    callbacks.forEach(callback => {
      callback(value, oldValue);
    });
    
    // æŒä¹…åŒ–å…³é”®çŠ¶æ€
    this.persistState(key, value);
  }
  
  // è·å–çŠ¶æ€
  getState(key) {
    return this.state[key];
  }
  
  // æŒä¹…åŒ–çŠ¶æ€
  persistState(key, value) {
    const persistKeys = ['loginInfo', 'currentSession'];
    if (persistKeys.includes(key)) {
      wx.setStorageSync(key, value);
    }
  }
}
```

#### é¡µé¢çŠ¶æ€ç®¡ç†
```javascript
class PageStateManager {
  constructor(page) {
    this.page = page;
    this.subscriptions = [];
  }
  
  // ç»‘å®šå…¨å±€çŠ¶æ€
  bindGlobalState(globalKey, localKey = globalKey) {
    const unsubscribe = globalStateManager.subscribe(globalKey, (newValue) => {
      this.page.setData({
        [localKey]: newValue
      });
    });
    
    this.subscriptions.push(unsubscribe);
    
    // åˆå§‹åŒ–æ•°æ®
    const initialValue = globalStateManager.getState(globalKey);
    if (initialValue !== undefined) {
      this.page.setData({
        [localKey]: initialValue
      });
    }
  }
  
  // é¡µé¢å¸è½½æ—¶æ¸…ç†è®¢é˜…
  cleanup() {
    this.subscriptions.forEach(unsubscribe => unsubscribe());
    this.subscriptions = [];
  }
}
```

### 4. å¾®ä¿¡ç™»å½•ç³»ç»Ÿ

#### ç™»å½•çŠ¶æ€æœº
```javascript
class LoginStateMachine {
  constructor() {
    this.state = 'LOGGED_OUT';
    this.transitions = {
      'LOGGED_OUT': {
        'LOGIN_START': 'LOGGING_IN',
        'AUTO_LOGIN': 'CHECKING_TOKEN'
      },
      'LOGGING_IN': {
        'LOGIN_SUCCESS': 'LOGGED_IN',
        'LOGIN_FAILURE': 'LOGGED_OUT'
      },
      'CHECKING_TOKEN': {
        'TOKEN_VALID': 'LOGGED_IN',
        'TOKEN_INVALID': 'LOGGED_OUT'
      },
      'LOGGED_IN': {
        'LOGOUT': 'LOGGED_OUT',
        'TOKEN_EXPIRED': 'LOGGED_OUT'
      }
    };
  }
  
  transition(event, data = null) {
    const currentTransitions = this.transitions[this.state];
    const nextState = currentTransitions[event];
    
    if (!nextState) {
      console.warn(`Invalid transition: ${this.state} -> ${event}`);
      return false;
    }
    
    const oldState = this.state;
    this.state = nextState;
    
    // è§¦å‘çŠ¶æ€å˜åŒ–äº‹ä»¶
    this.onStateChange(oldState, nextState, data);
    
    return true;
  }
  
  onStateChange(oldState, newState, data) {
    console.log(`Login state: ${oldState} -> ${newState}`);
    
    // æ ¹æ®çŠ¶æ€æ‰§è¡Œç›¸åº”æ“ä½œ
    switch (newState) {
      case 'LOGGED_IN':
        this.handleLoginSuccess(data);
        break;
      case 'LOGGED_OUT':
        this.handleLogout();
        break;
    }
  }
}
```

#### ç™»å½•æœåŠ¡
```javascript
class LoginService {
  constructor() {
    this.stateMachine = new LoginStateMachine();
    this.retryCount = 0;
    this.maxRetries = 3;
  }
  
  async checkLoginStatus() {
    const loginInfo = wx.getStorageSync('wxLoginInfo');
    if (!loginInfo) {
      return false;
    }
    
    // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
    const now = Date.now();
    const expireTime = 7 * 24 * 60 * 60 * 1000; // 7å¤©
    if (now - loginInfo.loginTime > expireTime) {
      this.clearLoginInfo();
      return false;
    }
    
    return true;
  }
  
  async login() {
    this.stateMachine.transition('LOGIN_START');
    
    try {
      // è·å–å¾®ä¿¡ç™»å½•ç 
      const loginResult = await this.wxLogin();
      const code = loginResult.code;
      
      // è°ƒç”¨åç«¯æ¥å£
      const sessionResult = await this.getSessionId(code);
      
      // ä¿å­˜ç™»å½•ä¿¡æ¯
      const loginInfo = {
        code,
        sessionData: sessionResult.data,
        loginTime: Date.now()
      };
      
      this.saveLoginInfo(loginInfo);
      this.stateMachine.transition('LOGIN_SUCCESS', loginInfo);
      
      return loginInfo;
    } catch (error) {
      this.stateMachine.transition('LOGIN_FAILURE', error);
      throw error;
    }
  }
  
  async wxLogin() {
    return new Promise((resolve, reject) => {
      wx.login({
        success: resolve,
        fail: reject
      });
    });
  }
}
```

### 5. æ•°æ®æŒä¹…åŒ–ç­–ç•¥

#### å­˜å‚¨å±‚æ¬¡è®¾è®¡
```javascript
class StorageManager {
  constructor() {
    this.memoryCache = new Map();
    this.storageKeys = {
      USER_INFO: 'userInfo',
      LOGIN_INFO: 'wxLoginInfo',
      KNOWLEDGE_BASES: 'knowledgeBases',
      CHAT_HISTORY: 'chatHistory'
    };
  }
  
  // å†…å­˜ç¼“å­˜
  setMemoryCache(key, value, ttl = 5 * 60 * 1000) { // é»˜è®¤5åˆ†é’Ÿ
    this.memoryCache.set(key, {
      value,
      expireTime: Date.now() + ttl
    });
  }
  
  getMemoryCache(key) {
    const item = this.memoryCache.get(key);
    if (!item) return null;
    
    if (Date.now() > item.expireTime) {
      this.memoryCache.delete(key);
      return null;
    }
    
    return item.value;
  }
  
  // æœ¬åœ°å­˜å‚¨
  setStorage(key, value) {
    try {
      wx.setStorageSync(key, {
        data: value,
        timestamp: Date.now()
      });
    } catch (error) {
      console.error('Storage set error:', error);
    }
  }
  
  getStorage(key, maxAge = null) {
    try {
      const item = wx.getStorageSync(key);
      if (!item) return null;
      
      if (maxAge && Date.now() - item.timestamp > maxAge) {
        this.removeStorage(key);
        return null;
      }
      
      return item.data;
    } catch (error) {
      console.error('Storage get error:', error);
      return null;
    }
  }
  
  // æ™ºèƒ½å­˜å‚¨ç­–ç•¥
  smartSet(key, value, options = {}) {
    const { 
      memoryTTL = 5 * 60 * 1000,
      persistToDisk = true,
      maxAge = null 
    } = options;
    
    // è®¾ç½®å†…å­˜ç¼“å­˜
    this.setMemoryCache(key, value, memoryTTL);
    
    // è®¾ç½®æœ¬åœ°å­˜å‚¨
    if (persistToDisk) {
      this.setStorage(key, value);
    }
  }
  
  smartGet(key, options = {}) {
    const { maxAge = null } = options;
    
    // å…ˆå°è¯•å†…å­˜ç¼“å­˜
    let value = this.getMemoryCache(key);
    if (value !== null) {
      return value;
    }
    
    // å†å°è¯•æœ¬åœ°å­˜å‚¨
    value = this.getStorage(key, maxAge);
    if (value !== null) {
      // å›å¡«å†…å­˜ç¼“å­˜
      this.setMemoryCache(key, value);
    }
    
    return value;
  }
}
```

## ğŸ”„ æ•°æ®æµè®¾è®¡

### å•å‘æ•°æ®æµ
```
ç”¨æˆ·æ“ä½œ â†’ Action â†’ Service â†’ API â†’ åç«¯
    â†‘                                  â†“
é¡µé¢æ›´æ–° â† State â† Store â† Response â† æ•°æ®å¤„ç†
```

### æ•°æ®æµå®ç°
```javascript
class DataFlowManager {
  constructor() {
    this.actionQueue = [];
    this.isProcessing = false;
  }
  
  // åˆ†å‘åŠ¨ä½œ
  async dispatch(action) {
    this.actionQueue.push(action);
    
    if (!this.isProcessing) {
      await this.processQueue();
    }
  }
  
  async processQueue() {
    this.isProcessing = true;
    
    while (this.actionQueue.length > 0) {
      const action = this.actionQueue.shift();
      await this.processAction(action);
    }
    
    this.isProcessing = false;
  }
  
  async processAction(action) {
    try {
      // 1. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
      const result = await this.executeAction(action);
      
      // 2. æ›´æ–°çŠ¶æ€
      this.updateState(action.type, result);
      
      // 3. è§¦å‘å‰¯ä½œç”¨
      this.triggerSideEffects(action, result);
      
    } catch (error) {
      this.handleError(action, error);
    }
  }
}
```

## ğŸ¯ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. æ¸²æŸ“ä¼˜åŒ–
```javascript
// è™šæ‹Ÿåˆ—è¡¨å®ç°
class VirtualList {
  constructor(options) {
    this.itemHeight = options.itemHeight;
    this.containerHeight = options.containerHeight;
    this.items = options.items;
    this.visibleCount = Math.ceil(this.containerHeight / this.itemHeight) + 2;
  }
  
  getVisibleItems(scrollTop) {
    const startIndex = Math.floor(scrollTop / this.itemHeight);
    const endIndex = Math.min(startIndex + this.visibleCount, this.items.length);
    
    return {
      items: this.items.slice(startIndex, endIndex),
      startIndex,
      offsetY: startIndex * this.itemHeight
    };
  }
}
```

### 2. ç½‘ç»œä¼˜åŒ–
```javascript
// è¯·æ±‚å»é‡
class RequestDeduplicator {
  constructor() {
    this.pendingRequests = new Map();
  }
  
  async request(key, requestFn) {
    if (this.pendingRequests.has(key)) {
      return this.pendingRequests.get(key);
    }
    
    const promise = requestFn();
    this.pendingRequests.set(key, promise);
    
    try {
      const result = await promise;
      return result;
    } finally {
      this.pendingRequests.delete(key);
    }
  }
}

// è¯·æ±‚ç¼“å­˜
class RequestCache {
  constructor() {
    this.cache = new Map();
  }
  
  get(key, maxAge = 5 * 60 * 1000) {
    const item = this.cache.get(key);
    if (!item) return null;
    
    if (Date.now() - item.timestamp > maxAge) {
      this.cache.delete(key);
      return null;
    }
    
    return item.data;
  }
  
  set(key, data) {
    this.cache.set(key, {
      data,
      timestamp: Date.now()
    });
  }
}
```

### 3. å†…å­˜ç®¡ç†
```javascript
class MemoryManager {
  constructor() {
    this.watchers = [];
    this.cleanupTasks = [];
  }
  
  // ç›‘æ§å†…å­˜ä½¿ç”¨
  startMemoryMonitoring() {
    const monitor = setInterval(() => {
      const memoryInfo = wx.getSystemInfoSync();
      if (memoryInfo.memoryWarning) {
        this.handleMemoryWarning();
      }
    }, 10000);
    
    this.watchers.push(() => clearInterval(monitor));
  }
  
  // å†…å­˜è­¦å‘Šå¤„ç†
  handleMemoryWarning() {
    console.warn('Memory warning detected, starting cleanup...');
    
    // æ¸…ç†ç¼“å­˜
    this.clearCaches();
    
    // æ‰§è¡Œæ¸…ç†ä»»åŠ¡
    this.cleanupTasks.forEach(task => task());
    
    // å¼ºåˆ¶åƒåœ¾å›æ”¶ï¼ˆå¦‚æœæ”¯æŒï¼‰
    if (typeof gc === 'function') {
      gc();
    }
  }
  
  // æ³¨å†Œæ¸…ç†ä»»åŠ¡
  registerCleanupTask(task) {
    this.cleanupTasks.push(task);
  }
}
```

## ğŸ”’ å®‰å…¨æ¶æ„

### 1. è¾“å…¥éªŒè¯
```javascript
class InputValidator {
  static validate(input, rules) {
    const errors = [];
    
    for (const rule of rules) {
      const result = rule.validate(input);
      if (!result.valid) {
        errors.push(result.message);
      }
    }
    
    return {
      valid: errors.length === 0,
      errors
    };
  }
  
  static createRule(type, options = {}) {
    const rules = {
      required: (value) => ({
        valid: value !== null && value !== undefined && value !== '',
        message: 'æ­¤å­—æ®µä¸ºå¿…å¡«é¡¹'
      }),
      
      maxLength: (value) => ({
        valid: !value || value.length <= options.max,
        message: `é•¿åº¦ä¸èƒ½è¶…è¿‡${options.max}ä¸ªå­—ç¬¦`
      }),
      
      pattern: (value) => ({
        valid: !value || options.regex.test(value),
        message: options.message || 'æ ¼å¼ä¸æ­£ç¡®'
      })
    };
    
    return rules[type];
  }
}
```

### 2. æ•°æ®åŠ å¯†
```javascript
class CryptoManager {
  constructor() {
    this.algorithm = 'AES-GCM';
    this.keyLength = 256;
  }
  
  // ç”Ÿæˆå¯†é’¥
  async generateKey() {
    return await crypto.subtle.generateKey(
      {
        name: this.algorithm,
        length: this.keyLength
      },
      true,
      ['encrypt', 'decrypt']
    );
  }
  
  // åŠ å¯†æ•°æ®
  async encrypt(data, key) {
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const encodedData = new TextEncoder().encode(JSON.stringify(data));
    
    const encrypted = await crypto.subtle.encrypt(
      {
        name: this.algorithm,
        iv: iv
      },
      key,
      encodedData
    );
    
    return {
      data: Array.from(new Uint8Array(encrypted)),
      iv: Array.from(iv)
    };
  }
  
  // è§£å¯†æ•°æ®
  async decrypt(encryptedData, key) {
    const decrypted = await crypto.subtle.decrypt(
      {
        name: this.algorithm,
        iv: new Uint8Array(encryptedData.iv)
      },
      key,
      new Uint8Array(encryptedData.data)
    );
    
    const decodedData = new TextDecoder().decode(decrypted);
    return JSON.parse(decodedData);
  }
}
```

## ğŸ“Š ç›‘æ§ä¸æ—¥å¿—

### 1. æ€§èƒ½ç›‘æ§
```javascript
class PerformanceMonitor {
  constructor() {
    this.metrics = new Map();
    this.observers = [];
  }
  
  // å¼€å§‹æ€§èƒ½æµ‹é‡
  startMeasure(name) {
    this.metrics.set(name, {
      startTime: Date.now(),
      startMemory: this.getMemoryUsage()
    });
  }
  
  // ç»“æŸæ€§èƒ½æµ‹é‡
  endMeasure(name) {
    const metric = this.metrics.get(name);
    if (!metric) return;
    
    const endTime = Date.now();
    const endMemory = this.getMemoryUsage();
    
    const result = {
      name,
      duration: endTime - metric.startTime,
      memoryDelta: endMemory - metric.startMemory,
      timestamp: endTime
    };
    
    this.reportMetric(result);
    this.metrics.delete(name);
  }
  
  // è·å–å†…å­˜ä½¿ç”¨æƒ…å†µ
  getMemoryUsage() {
    try {
      const systemInfo = wx.getSystemInfoSync();
      return systemInfo.memorySize || 0;
    } catch (error) {
      return 0;
    }
  }
  
  // ä¸ŠæŠ¥æ€§èƒ½æŒ‡æ ‡
  reportMetric(metric) {
    console.log('Performance metric:', metric);
    
    // å‘é€åˆ°ç›‘æ§æœåŠ¡
    this.sendToMonitoringService(metric);
  }
}
```

### 2. é”™è¯¯ç›‘æ§
```javascript
class ErrorMonitor {
  constructor() {
    this.errorQueue = [];
    this.isReporting = false;
    this.setupGlobalErrorHandler();
  }
  
  setupGlobalErrorHandler() {
    // æ•è·æœªå¤„ç†çš„é”™è¯¯
    wx.onError((error) => {
      this.captureError(error, 'unhandled');
    });
    
    // æ•è·æœªå¤„ç†çš„Promiseæ‹’ç»
    wx.onUnhandledRejection((event) => {
      this.captureError(event.reason, 'unhandledRejection');
    });
  }
  
  captureError(error, type = 'manual') {
    const errorInfo = {
      message: error.message || error,
      stack: error.stack,
      type,
      timestamp: Date.now(),
      userAgent: wx.getSystemInfoSync(),
      url: getCurrentPages().pop()?.route
    };
    
    this.errorQueue.push(errorInfo);
    this.reportErrors();
  }
  
  async reportErrors() {
    if (this.isReporting || this.errorQueue.length === 0) {
      return;
    }
    
    this.isReporting = true;
    
    try {
      const errors = this.errorQueue.splice(0, 10); // æ‰¹é‡ä¸ŠæŠ¥
      await this.sendErrorsToService(errors);
    } catch (reportError) {
      console.error('Failed to report errors:', reportError);
    } finally {
      this.isReporting = false;
    }
  }
}
```

è¿™ä¸ªæŠ€æœ¯æ¶æ„æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†é¡¹ç›®çš„æ ¸å¿ƒæŠ€æœ¯å®ç°ï¼ŒåŒ…æ‹¬åˆ†å±‚æ¶æ„ã€æ¨¡å—åŒ–è®¾è®¡ã€æ ¸å¿ƒç»„ä»¶å®ç°ã€æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ã€å®‰å…¨æ¶æ„å’Œç›‘æ§ç³»ç»Ÿã€‚æ¯ä¸ªéƒ¨åˆ†éƒ½æä¾›äº†å…·ä½“çš„ä»£ç ç¤ºä¾‹å’Œå®ç°ç»†èŠ‚ï¼Œä¸ºé¡¹ç›®çš„æŠ€æœ¯è®²è§£æä¾›äº†å…¨é¢çš„æ”¯æ’‘ã€‚ 